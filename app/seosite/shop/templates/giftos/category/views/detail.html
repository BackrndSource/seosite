{% extends "giftos/layouts/base.html" %}
{% load shop_extras %}

{% block title %}{{category.title}}{% endblock %}
{% block meta_description %}{{category.meta_description}}{% endblock %}
{% block meta_keywords %}{{category.keywords}}{% endblock %}

{% block og_title %}{{category.title}}{% endblock %}
{% block og_description %}{{category.meta_description}}{% endblock %}
{% block meta_extra %}
<meta property="og:image" content="{{category.image}}" />
<meta property="og:image:width" content="{{category.image_width}}" />
<meta property="og:image:height" content="{{category.image_height}}" />
<!-- Canonical -->
<link rel="canonical" href="{% if request.is_secure %}https://{% else %}http://{% endif %}{{request.get_host}}{% url 'category-slug' category.slug %}">
{% endblock %}



<!-- FEATURED PRODUCTS -->
{% block hero %}{% include "giftos/product/components/hero.html" with products=featured_products %}{% endblock %}

{% block content %}
<!-- CATEGORIES NAV -->
{% include "giftos/category/components/nav.html" with categories=shop_categories active_category=category %}

<!-- CATEGORY DETAILS - DESCRIPTION -->
<section class="my-5">
    <div class="container">
        <div class="row">
            <div class="col-12" style="font-size: 1.25rem;">
                {{category.description}}
            </div>
        </div>
        {% if user.is_staff %}
        <div class="row py-3">
            <div class="col-12 d-flex justify-content-center align-items-center ">
                <a target="_blank" href="/admin/shop/category/{{category.id}}/change" class="btn btn-primary mr-2"><i class="fa fa-edit"></i>
                    Editar categoría {{category.title}}</a>
            </div>
        </div>
        {% endif %}
    </div>
</section>

<!-- SUB CATEGORIES LIST -->
{% if category.childs.all.count > 0 %}
{% include "giftos/category/components/list.html" with categories=category|childs %}
{% endif %}

<!-- PROMO PRODUCTS -->
{% if promo_products.count > 0 %}
{% include "giftos/product/components/list.html" with products=promo_products.all|slice:":4" title="Últimas oportunidades"%}
{% endif %}

<!-- CATEGORY DETAILS - TEXT -->
<section class="my-5">
    <div class="container">
        <div class="row">
            <div class="col-12">
                {{category.text|safe}}
            </div>
        </div>
    </div>
</section>

<!-- BEST SELLING PRODUCTS -->
{% if bestselling_products.count > 0 %}
{% include "giftos/product/components/list.html" with products=bestselling_products.all|slice:":4" title="Los más vendidos"%}
{% endif %}

<!-- REVIEWS LIST -->
{% if reviews.count > 0 %}
{% include "giftos/review/components/carousel.html" with title=category.title reviews=reviews %}
{% endif %}

<!-- BEST RATED PRODUCTS -->
{% if bestrated_products.count > 0 %}
{% include "giftos/product/components/list.html" with products=bestrated_products.all|slice:":4" title="Mejor valorados"%}
{% endif %}

<!-- ALL PRODUCTS -->
{% if category|products is not None %}
{% include "giftos/product/components/list.html" with products=category|products title="Todos los productos"%}
{% endif %}

{% endblock %}


{% block script_extra %} 
<script>
    {
        "@context":"https://schema.org",
        "@type":"ItemList",
        "url": "{% if request.is_secure %}https://{% else %}http://{% endif %}{{request.get_host}}{% url 'category-slug' category.slug %}",
        "numberOfItems": "{{category|products.count}}",
        "itemListElement":[
            {% for product in category|products %}
            {
                "@type":"Product",
                "url":"{% if request.is_secure %}https://{% else %}http://{% endif %}{{request.get_host}}{% url 'product-slug' product.slug %}",
                "asin": "{{product.asin}}"
                "aggregateRating": {
                    "@type": "AggregateRating",
                    "ratingValue": "{{product.rating}}",
                    "reviewCount": "{{product.rating_count}}"
                },
                "description": "{{product.description}}",
                "name": "{{product.title}}",
                "image":  [
                    {% for image in product.images.all %}
                    "{{image.large}}",
                    {% endfor %}
                ],
                "offers": {
                    "@type": "Offer",
                    "availability": "https://schema.org/InStock",
                    "price": "{{product.price}}",
                    "priceCurrency": "EUR"
                },
                "review": [
                    {% for review in product.reviews.all %}
                    {
                    "@type": "Review",
                    "author": "{{review.author}}",
                    "datePublished": "{{review.created_date}}",
                    "reviewBody": "{{review.text}}",
                    "name": "{{review.title}}",
                    "reviewRating": {
                        "@type": "Rating",
                        "bestRating": "5",
                        "ratingValue": "{{review.rating}}",
                        "worstRating": "1"
                    }
                    },
                    {% endfor %}
                ]
            },
            {% endfor %}
        ]
      }
</script>
{% endblock %}