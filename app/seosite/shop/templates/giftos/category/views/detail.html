{% extends "giftos/layouts/base.html" %}
{% load shop_extras %}

{% block title %}{{category.title}}{% endblock %}
{% block meta_description %}{{category.meta_description|slice:":159"}}{% endblock %}
{% block meta_keywords %}{{category.keywords}}{% endblock %}
{% block meta_extra %}

<!-- Facebook Meta Tags -->
<meta property="og:url" content="{{shop_config.canonical_url}}{% url 'category-slug' category.slug %}">
<meta property="og:type" content="website">
<meta property="og:locale" content="es_ES" />
<meta property="og:title" content="{{category.title}}">
<meta property="og:description" content="{{category.meta_description}}">
<meta property="og:image" content="{% if category.image %}{{shop_config.canonical_url}}{{category.image.url}}{% endif %}" />
<meta property="og:image:width" content="{{category.image_width}}" />
<meta property="og:image:height" content="{{category.image_height}}" />

<!-- Twitter Meta Tags -->
<meta name="twitter:card" content="summary_large_image">
<meta property="twitter:domain" content="{{shop_config.canonical_url}}">
<meta property="twitter:url" content="{{shop_config.canonical_url}}{% url 'category-slug' category.slug %}">
<meta name="twitter:title" content="{{category.title}}">
<meta name="twitter:description" content="{{category.meta_description}}">
<meta name="twitter:image" content="{% if category.image %}{{shop_config.canonical_url}}{{category.image.url}}{% endif %}">
  
<!-- Canonical -->
<link rel="canonical" href="{{shop_config.canonical_url}}{% url 'category-slug' category.slug %}">

{% endblock %}

{% block content %}
<!-- CATEGORIES NAV -->
{% include "giftos/category/components/nav.html" with categories=shop_categories %}

<!-- CATEGORY DETAILS - DESCRIPTION -->
<section class="my-4">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-12 {% if category.image %}col-md-7{% endif %} text-center" style="font-size: 1.25rem;">
                <h1 class="pb-3" style="font-size: 2.7rem;">
                    {{category.title}}
                </h1>
                <p class="text-center">
                    {{category.description}}
                </p>
            </div>
            {% if category.image %}
            <div class="col-12 col-md-5 overflow-hidden d-flex align-items-center justify-content-center" style="font-size: 1.25rem; height: 30vh;">
                <img  style="height:100%;width:auto;" height="300" width="300" data-src="{{category.image.url}}" class="lazy" alt="Imagen de la categoría {{category.title}}">
                </p>
            </div>
            {% endif %}
        </div>
        {% if user.is_staff %}
        <div class="row py-3">
            <div class="col-12 d-flex justify-content-center align-items-center ">
                <a target="_blank" href="/admin/shop/category/{{category.id}}/change" class="btn btn-primary mr-2">Editar categoría {{category.title}}</a>
            </div>
        </div>
        {% endif %}
    </div>
</section>

{% with subcategories=category|childs %}
{% if subcategories.count > 0 %}
<div class="container">
    <ul class="nav border-top border-bottom border-secondary w-100 justify-content-center text-uppercase"  style="font-size: 1.2rem;"  id="navbarSubCategories">
        {% for subcategory in subcategories %}
        {% with childs=subcategory|childs %}
        {% if childs.count > 0 %}
        <li class="nav-item dropdown px-4 d-flex flex-wrap justify-content-center align-items-center">
            <a style="color: black;" href="{% url 'category-slug' subcategory.slug %}">
                {{subcategory.title}}
            </a>
            <a style="color: black;" role="button" href="#" class="nav-link dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <span class="sr-only">Toggle Dropdown</span>
            </a>
            <div class="dropdown-menu">
                {% for child in childs %}
                <a class="dropdown-item" href="{% url 'category-slug' child.slug %}">{{child.title}}</a>
                {% endfor %}
            </div>
        </li>
        {% else %}
        <li class="nav-item px-4">
            <a style="color: black;" class="nav-link"
                href="{% url 'category-slug' subcategory.slug %}">{{subcategory.title}}</a>
        </li>
        {% endif %}
        {% endwith %}
        {% endfor %}
    </ul>
</div>
{% endif %}
{% endwith %}

<!-- SUB CATEGORIES LIST -->
{% if category.childs.all.count > 0 %}
{% include "giftos/category/components/list.html" with categories=category|childs %}
{% endif %}

<!-- PROMO PRODUCTS -->
{% if promo_products.count > 0 %}
{% include "giftos/product/components/list.html" with products=promo_products.all|slice:":4" title="Últimas oportunidades"%}
{% endif %}

<!-- CATEGORY DETAILS - TEXT -->
<section class="my-5">
    <div class="container">
        <div class="row">
            <div class="col-12 text-center">
                {{category.text|safe}}
            </div>
        </div>
    </div>
</section>

<!-- BEST SELLING PRODUCTS -->
{% if bestselling_products.count > 0 %}
{% include "giftos/product/components/list.html" with products=bestselling_products.all|slice:":4" title="Los más vendidos"%}
{% endif %}

<!-- REVIEWS LIST -->
{% if reviews.count > 0 %}
{% include "giftos/review/components/carousel.html" with title=category.title reviews=reviews %}
{% endif %}

<!-- BEST RATED PRODUCTS -->
{% if bestrated_products.count > 0 %}
{% include "giftos/product/components/list.html" with products=bestrated_products.all|slice:":4" title="Mejor valorados"%}
{% endif %}

<!-- ALL PRODUCTS -->
{% if category|products is not None %}
{% include "giftos/product/components/list.html" with products=category|products title="Todos los productos"%}
{% endif %}

{% endblock %}

{% block script_extra %} 
<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "ItemList",
        "url": "{{shop_config.canonical_url}}{% url 'category-slug' category.slug %}",
        "itemListElement":[
            {% for product in category|products %}
            {
                "@type": "Product",
                "position": {{foorloop.counter}}
                "url":"{{shop_config.canonical_url}}{% url 'product-slug' product.slug %}",
                "asin": "{{product.asin}}",
                "aggregateRating": {
                    "@type": "AggregateRating",
                    "ratingValue": {{product.rating|stringformat:'.2f'}},
                    "reviewCount": {{product.rating_count}}
                },
                "description": "{{product.description}}",
                "name": "{{product.title}}",
                "image": "{{product.images.first.large}}",
                "offers": {
                    "@type": "Offer",
                    "availability": "https://schema.org/InStock",
                    "price": {{product.price|stringformat:'.2f'}},
                    "priceCurrency": "EUR",
                    "priceValidUntil": "2025-01-01",
                    "shippingDetails": {
                        "@type": "OfferShippingDetails",
                        "deliveryTime": {
                            "@type": "ShippingDeliveryTime",
                            "businessDays": {
                                "@type": "OpeningHoursSpecification",
                                "dayOfWeek": [
                                    "https://schema.org/Monday",
                                    "https://schema.org/Tuesday",
                                    "https://schema.org/Wednesday",
                                    "https://schema.org/Thursday",
                                    "https://schema.org/Friday",
                                    "https://schema.org/Saturday",
                                    "https://schema.org/Sunday"
                                ]
                            },
                            "cutoffTime": "12:00:15Z",
                            "handlingTime": {
                                "@type": "QuantitativeValue",
                                "minValue": 1,
                                "maxValue": 2,
                                "unitCode": "d"
                            },
                            "transitTime": {
                                "@type": "QuantitativeValue",
                                "minValue": 1,
                                "maxValue": 3,
                                "unitCode": "d"
                            }
                        },
                        "shippingRate": {
                            "@type": "MonetaryAmount",
                            "value": 0,
                            "currency": "EUR"
                        }
                    },
                    "hasMerchantReturnPolicy": {
                        "@type": "MerchantReturnPolicy",
                        "returnPolicyCategory": "http://schema.org/MerchantReturnUnlimitedWindow",
                        "returnFees": "http://schema.org/FreeReturn",
                        "refundType": "https://schema.org/FullRefund",
                        "returnPolicyCountry": "ES",
                        "merchantReturnDays": 30,
                        "merchantReturnLink": "https://deniños.com/politica-de-devolucion",
                        "restockingFee": {
                        "@type": "MonetaryAmount",
                        "value": 0,
                        "currency": "EUR"
                        }
                    }
                }
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
    }
</script>
{% endblock %}